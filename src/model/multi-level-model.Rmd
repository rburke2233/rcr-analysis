---
title: "Multi-level Model"
author: "Robin Burke"
date: "11/27/2016"
output: html_document
---

This file computes a multi-level linear model of the circulation data against the library data represented as the principal components of the demographic representation and the book holdings.

```{r}
library(knitr)
setwd("/home/rburke/oboc/src/")
read_chunk("multi-level-model.R")
```

### Project constants

```{r C1}
```

### Load libraries

```{r C2}
```

## Loading the data

### Library data including principal components

```{r C3}
```

### OBOC circulation data

As it turns out, this series it pretty closely correlated with the library holdings for each book. (Perhaps not surprising as this is likely how titles were/are allocated.)

```{r C4}
```


### Holdings data

```{r C5}
```

### Compute book-wise branch circulation

Scale to the range closer to the principal component values

```{r C6}
```

### Compute book-wise branch visitors

Scale to the range closer to the principal component values

```{r C7}
```

### Perform joins

```{r C8}
```

### Create data subsets

noH0 drops Harold Washington. noRG drops Harold Washington and the regional libraries. PW is dropped because it has no visitor data on the City of Chicago site.

```{r C9}
```

### Correlation of circulation and visitors

```{r C10}
```

These values are highly correlated. We will use only visitors.

## Lattice plots full data

Plot the checkout frequency against the model variables.

### Holdings

```{r LPFull1}
```

### Total branch visitors

```{r LPFull2}
```

### Principal component 1

```{r LPFull3}
```

### Principal component 2

```{r LPFull4}
```

### Principal component 3

```{r LPFull5}
```

### Principal component 4

```{r LPFull6}
```

Clearly the non-branch libraries are huge outliers with respect to this model. We will need to handle them separately. 

## Lattice plots with branch only data

### Holdings

```{r LPRG1}
```

### Total branch visitors

```{r LPRG2}
```

Chinatown branch (CH) is a big outlier in almost all the visitor graphs.

### Principal component 1

```{r LPRG3}
```

### Principal component 2

```{r LPRG4}
```

This does not look like a trend. It looks like a peak around 0.

### Principal component 3

```{r LPRG5}
```

### Principal component 4

```{r LPRG6}
```

### Transformed data set

Examining the linear properties of PC2 vs abs(PC2)

```{r C11}
```

Clearly the squared value is a superior fit. Recall that PC2 represents an ethnic dimension in the city the black -- Hispanic dimension. A high squared value therefore means that the region is highly segregated on this dimension, whereas near zero value means that it is more integrated.

Using square to transform PC2.
```{r C12}
```

### Lattice plot with transformed variable
```{r LPXF1}
```

## Modeling

### Linear model without mixed effects

```{r M1}
```

Even without hierarchy the model terms are significant, except for PC2X. 

### Mixed-effects model with only fixed effects (Books)

```{r M2}
```

Coefficients show the different popularities of the books.

### Mixed-effects model with only fixed effects (Branches)

```{r M3}
```

Clearly, branches account for a lot of variance

### ME model fixed effects plus linear model for demographics

```{r M4}
```

### Full ME model with fixed effects and random effects
```{r MBad}
```

Does not converge

### Reduced model

```{r M5}
```

This is about the same as M4, but it has parameters for all the branches. 

### Fixed effects ranges for the model
```{r C13}
```

### Random effects ranges for the model
```{r C14}
```

### Save the model fit
```{r C15}
```

### Data frame for the model coefficients
```{r C16}
```

### Save the coefficients
```{r C17}
```

## Plot the model coefficients

### Principal components
```{r PCoef1}
```

All negative slopes.

### The slope for holdings
```{r PCoef2}
```

### The intercepts
```{r PCoef3}
```

## Weighted model

### Use robust regression to estimate weights for the observations.
```{r RLM1}
```

### Plot the weights for the observations

Note that H0 and S1 are zero or close to it, justifying our regional exclusion idea.

```{r PWeight}
```

### Full data multi-level model

This version includes all the observations, but uses the robust weights. If we use them directly, the model fails to converge, so we add a small epsilon (0.1) to all the weights.
```{r M5F}
```

## Coefficients for the full model

### Create data frame
```{r C18}
```

### Save the coefficients
```{r C19}
```

## Plot the model coefficients

### Principal components
```{r PCoef4}
```

All negative slopes.

### The slope for holdings
```{r PCoef5}
```

### The intercepts
```{r PCoef6}
```

